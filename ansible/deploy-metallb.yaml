# ============================================================
# Playbook : Deploy MetalLB
# Fichier  : deploy-metallb.yaml
# ============================================================

- name: "K8S ADDON | Deploy MetalLB"
  hosts: tf-k8s-master
  become: true

  vars:
    repo_url: "https://github.com/egoMasa/DevOps-JFKZ.git"
    repo_version: "main"
    repo_dest: "/opt/devops-jfkz"

    kubeconfig_path: "/etc/kubernetes/admin.conf"

    metallb_native_url: "https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml"
    metallb_config_file: "{{ repo_dest }}/k8s/00-metallb/metallb-config.yaml"

    metallb_speaker_label_key: "metallb-speaker"

    metallb_workers:
      - tf-k8s-node-1
      - tf-k8s-node-2

    metallb_master_node: "tf-k8s-master"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - name: Ensure git is installed
      apt:
        name: git
        state: present
        update_cache: true

    - name: Clone or update manifests repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_version }}"
        force: true

    # ------------------------------------------------------------
    # Node labels (speaker only on workers)
    # ------------------------------------------------------------
    - name: Label workers for MetalLB speaker
      command: kubectl label node {{ item }} {{ metallb_speaker_label_key }}=true --overwrite
      loop: "{{ metallb_workers }}"

    - name: Exclude master from MetalLB speaker
      command: kubectl label node {{ metallb_master_node }} {{ metallb_speaker_label_key }}=false --overwrite

    # ------------------------------------------------------------
    # 1) Install MetalLB (CRDs + controller + speaker)
    # ------------------------------------------------------------
    - name: Install MetalLB (official manifest)
      command: kubectl apply -f {{ metallb_native_url }}
      register: metallb_native_apply

    - name: Wait for MetalLB CRDs
      shell: |
        kubectl wait --for=condition=Established crd/ipaddresspools.metallb.io --timeout=60s
        kubectl wait --for=condition=Established crd/l2advertisements.metallb.io --timeout=60s
      changed_when: false

    - name: Wait MetalLB controller rollout
      command: kubectl -n metallb-system rollout status deploy/controller --timeout=180s

    - name: Wait MetalLB speaker rollout
      command: kubectl -n metallb-system rollout status ds/speaker --timeout=180s

    # ------------------------------------------------------------
    # 2) Apply MetalLB configuration (pool + L2)
    # ------------------------------------------------------------
    - name: Apply MetalLB configuration
      command: kubectl apply -f {{ metallb_config_file }}
      register: metallb_config_apply

    # ------------------------------------------------------------
    # Status checks
    # ------------------------------------------------------------
    - name: Get MetalLB pods
      command: kubectl -n metallb-system get pods -o wide
      register: metallb_pods
      changed_when: false

    - name: Get MetalLB IPAddressPools
      command: kubectl get ipaddresspools.metallb.io -A
      register: metallb_pools
      changed_when: false

    - name: Get MetalLB L2Advertisements
      command: kubectl get l2advertisements.metallb.io -A
      register: metallb_l2adv
      changed_when: false

    - name: Show MetalLB summary
      debug:
        msg: |
          ================================
          ✅ MetalLB Deployment OK
          ================================

          ▶ Pods
          {{ metallb_pods.stdout }}

          ▶ IPAddressPools
          {{ metallb_pools.stdout }}

          ▶ L2Advertisements
          {{ metallb_l2adv.stdout }}
