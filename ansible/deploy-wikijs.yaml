---
- name: Deploy Wiki.js (Init phase) using repo values file
  hosts: k8s_master
  become: true
  gather_facts: true

  vars:
    repo_url: "https://github.com/egoMasa/DevOps-JFKZ.git"
    repo_version: "main"
    repo_dest: "/opt/devops-jfkz"

    # âœ… Existing file path in the repo
    wikijs_values_file: "{{ repo_dest }}/k8s/02-wikijs/values-wikijs.yaml"

    wikijs_namespace: "wikijs"
    wikijs_release: "wikijs"
    wikijs_chart: "requarks/wiki"

    helm_bin: "/usr/local/bin/helm"

  tasks:
    - name: Install required packages (git, curl)
      ansible.builtin.apt:
        name:
          - git
          - curl
        state: present
        update_cache: true

    - name: Clone project repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: "{{ repo_version }}"
        update: true

    - name: Ensure values file exists in repo
      ansible.builtin.stat:
        path: "{{ wikijs_values_file }}"
      register: values_stat

    - name: Fail if values file is missing
      ansible.builtin.fail:
        msg: "Missing values file: {{ wikijs_values_file }} (check repo path k8s/02-wikijs/values-wikijs.yaml)"
      when: not values_stat.stat.exists

    - name: Install Helm 3 (only if not already installed)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        executable: /bin/bash
        creates: "{{ helm_bin }}"

    - name: Show Helm version
      ansible.builtin.command: "{{ helm_bin }} version"
      register: helm_version
      changed_when: false

    - name: Add requarks Helm repo (idempotent)
      ansible.builtin.command: "{{ helm_bin }} repo add requarks https://charts.js.wiki"
      register: helm_repo_add
      changed_when: "'has been added' in helm_repo_add.stdout"
      failed_when: false

    - name: Helm repo update
      ansible.builtin.command: "{{ helm_bin }} repo update"
      changed_when: false

    - name: Ensure namespace exists
      ansible.builtin.command: "kubectl get ns {{ wikijs_namespace }}"
      register: ns_check
      failed_when: false
      changed_when: false

    - name: Create namespace if missing
      ansible.builtin.command: "kubectl create namespace {{ wikijs_namespace }}"
      when: ns_check.rc != 0

    - name: Check if Wiki.js release already exists
      ansible.builtin.command: "{{ helm_bin }} -n {{ wikijs_namespace }} list -q"
      register: helm_list
      changed_when: false

    - name: Install Wiki.js (INIT phase, expects replicaCount=1 in values)
      ansible.builtin.command: >
        {{ helm_bin }} install {{ wikijs_release }} {{ wikijs_chart }}
        -n {{ wikijs_namespace }}
        -f {{ wikijs_values_file }}
      when: wikijs_release not in helm_list.stdout_lines

    - name: If release exists, upgrade to ensure values are applied
      ansible.builtin.command: >
        {{ helm_bin }} upgrade {{ wikijs_release }} {{ wikijs_chart }}
        -n {{ wikijs_namespace }}
        -f {{ wikijs_values_file }}
      when: wikijs_release in helm_list.stdout_lines

    - name: Wait for deployment rollout
      ansible.builtin.command: "kubectl -n {{ wikijs_namespace }} rollout status deploy/{{ wikijs_release }} --timeout=180s"
      register: rollout
      changed_when: false
      failed_when: false

    - name: Show pods
      ansible.builtin.command: "kubectl -n {{ wikijs_namespace }} get pods -o wide"
      register: pods_out
      changed_when: false

    - name: Show ingress
      ansible.builtin.command: "kubectl -n {{ wikijs_namespace }} get ingress -o wide"
      register: ingress_out
      changed_when: false

    - name: Show last logs (tail)
      ansible.builtin.command: "kubectl -n {{ wikijs_namespace }} logs deploy/{{ wikijs_release }} --tail=120"
      register: logs_out
      failed_when: false
      changed_when: false

    - name: Print summary / next manual step (setup in browser)
      ansible.builtin.debug:
        msg:
          - "Helm: {{ helm_version.stdout }}"
          - "Values file used: {{ wikijs_values_file }}"
          - "Pods:\n{{ pods_out.stdout }}"
          - "Ingress:\n{{ ingress_out.stdout }}"
          - "Logs (tail):\n{{ logs_out.stdout | default('no logs yet') }}"
          - "NEXT: Point wikijs.lab to the ingress EXTERNAL-IP (MetalLB) from ingress-nginx-controller service."
          - "Then open: http://wikijs.lab/ and complete the setup wizard (admin + Site URL)."
