# ============================================================
# Playbook : Installation Complète et Initialisation MASTER
# Fichier  : deploy_k8s_master.yml
#
# Objectifs :
# 1) OS baseline K8s (swap, modules, sysctl)
# 2) containerd stable (SystemdCgroup=true)
# 3) Installation kubeadm/kubelet/kubectl via pkgs.k8s.io (v1.29.x)
# 4) kubeadm init (idempotent)
# 5) Calico install + attente réelle (DaemonSet + CNI file)
# 6) Patch IPPool (VXLAN + natOutgoing) seulement quand Calico est up
# 7) Join command
# ============================================================

- name: "K8S MASTER | Installation et Initialisation"
  hosts: tf-k8s-master
  become: true

  vars:
    k8s_minor_version: "1.29"
    pod_network_cidr: "10.244.0.0/16"

    calico_manifest_url: "https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml"

    kubeconfig_path: "/etc/kubernetes/admin.conf"
    kubeconfig_user: "ansible"
    kubeconfig_user_home: "/home/ansible"
    kubeconfig_user_path: "/home/ansible/.kube/config"

    join_cmd_remote_path: "/root/join-workers.sh"
    join_cmd_local_dir: "./artifacts"
    join_cmd_local_path: "./artifacts/join-workers.sh"

    # LAB: à mettre true UNE fois si tu rebuild
    force_reset: false

  pre_tasks:
    - name: Ensure local artifacts directory exists (controller)
      delegate_to: localhost
      run_once: true
      become: false
      file:
        path: "{{ join_cmd_local_dir }}"
        state: directory
        mode: "0755"

  tasks:

    # ------------------------------------------------------------
    # 1) OS baseline
    # ------------------------------------------------------------
    - name: Disable swap (runtime)
      command: swapoff -a
      when: ansible_swaptotal_mb | int > 0

    - name: Disable swap permanently in /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^\s*([^#].*\sswap\s.*)$'
        replace: '# \1'

    - name: Load required kernel modules immediately
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - bridge
        - br_netfilter

    - name: Persist kernel modules
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          bridge
          br_netfilter
        mode: "0644"

    - name: Configure sysctl for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

          # Important en overlay (évite des NotReady chelous)
          net.ipv4.conf.all.rp_filter         = 0
          net.ipv4.conf.default.rp_filter     = 0

          # Utile plus tard pour MetalLB L2 (évite ICMP redirects)
          net.ipv4.conf.all.send_redirects    = 0
          net.ipv4.conf.default.send_redirects= 0
        mode: "0644"

    - name: Apply sysctl parameters
      command: sysctl --system

    # ------------------------------------------------------------
    # 2) containerd + outils réseau nécessaires à kube-proxy/CNI
    # ------------------------------------------------------------
    - name: Install containerd and helpers
      apt:
        name:
          - containerd
          - conntrack
          - ipset
          - iptables
          - iproute2
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Ensure containerd config directory exists
      file:
        path: /etc/containerd
        state: directory
        mode: "0755"

    - name: Generate default containerd config (always) for consistency
      shell: containerd config default > /etc/containerd/config.toml

    - name: Enable systemd cgroup driver
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'
      notify: Restart containerd

    - name: Ensure containerd is enabled and running
      systemd:
        name: containerd
        state: started
        enabled: true

    # ------------------------------------------------------------
    # 3) Kubernetes packages via pkgs.k8s.io
    # ------------------------------------------------------------
    - name: Ensure apt keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Kubernetes apt key (pkgs.k8s.io)
      shell: |
        set -e
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_version }}/deb/Release.key \
        | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Add Kubernetes apt repository (pkgs.k8s.io)
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_version }}/deb/ /
        mode: "0644"

    - name: Install kubelet/kubeadm/kubectl
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: true

    - name: Hold Kubernetes packages
      command: apt-mark hold kubelet kubeadm kubectl

    # ------------------------------------------------------------
    # 4) Optional reset (LAB)
    # ------------------------------------------------------------
    - name: Reset cluster (optional)
      command: kubeadm reset -f
      when: force_reset | bool

    - name: Remove CNI configs (optional)
      file:
        path: /etc/cni/net.d
        state: absent
      when: force_reset | bool

    - name: Restart services after reset (optional)
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - containerd
        - kubelet
      when: force_reset | bool

    # ------------------------------------------------------------
    # 5) kubeadm init (idempotent)
    # ------------------------------------------------------------
    - name: Check if cluster already initialized
      stat:
        path: "{{ kubeconfig_path }}"
      register: k8s_init

    - name: Initialize Kubernetes control-plane
      command: kubeadm init --pod-network-cidr={{ pod_network_cidr }}
      when: not k8s_init.stat.exists

    # ------------------------------------------------------------
    # 6) kubeconfig user
    # ------------------------------------------------------------
    - name: Create .kube directory
      file:
        path: "{{ kubeconfig_user_home }}/.kube"
        state: directory
        owner: "{{ kubeconfig_user }}"
        group: "{{ kubeconfig_user }}"
        mode: "0755"

    - name: Copy admin.conf to user kubeconfig
      copy:
        src: "{{ kubeconfig_path }}"
        dest: "{{ kubeconfig_user_path }}"
        owner: "{{ kubeconfig_user }}"
        group: "{{ kubeconfig_user }}"
        mode: "0644"
        remote_src: true

    # ------------------------------------------------------------
    # 7) Wait API
    # ------------------------------------------------------------
    - name: Wait kube-apiserver port 6443
      wait_for:
        host: 127.0.0.1
        port: 6443
        timeout: 300

    # ------------------------------------------------------------
    # 8) Calico install + waits "réels"
    # ------------------------------------------------------------
    - block:
        - name: Apply Calico manifest
          command: kubectl apply -f {{ calico_manifest_url }} --kubeconfig={{ kubeconfig_path }}
          register: calico_apply
          retries: 10
          delay: 6
          until: calico_apply.rc == 0

        - name: Wait Calico DS rollout (can take time on first pull)
          command: kubectl -n kube-system rollout status ds/calico-node --timeout=600s --kubeconfig={{ kubeconfig_path }}

        - name: Wait for CNI config file (Calico)
          wait_for:
            path: /etc/cni/net.d/10-calico.conflist
            state: present
            timeout: 300

        - name: Wait for master Ready (after CNI is present)
          command: kubectl wait --for=condition=Ready node/tf-k8s-master --timeout=600s --kubeconfig={{ kubeconfig_path }}

        - name: Patch Calico IPPool (VXLAN + NAT)
          command: >
            kubectl patch ippool default-ipv4-ippool --type merge -p
            '{"spec":{"cidr":"{{ pod_network_cidr }}","vxlanMode":"Always","ipipMode":"Never","natOutgoing":true}}'
            --kubeconfig={{ kubeconfig_path }}

      rescue:
        - name: Dump nodes
          command: kubectl get nodes -o wide --kubeconfig={{ kubeconfig_path }}
          failed_when: false

        - name: Dump kube-system pods
          command: kubectl -n kube-system get pods -o wide --kubeconfig={{ kubeconfig_path }}
          failed_when: false

        - name: Describe node (first 200 lines)
          shell: |
            kubectl describe node tf-k8s-master --kubeconfig={{ kubeconfig_path }} | sed -n '1,200p'
          args:
            executable: /bin/bash
          failed_when: false

        - name: Journal kubelet (last 120 lines)
          shell: journalctl -u kubelet -n 120 --no-pager
          failed_when: false

        - name: Fail with explicit message
          fail:
            msg: "Calico/CNI not ready -> see debug output above (pods, node describe, kubelet logs)."

    # ------------------------------------------------------------
    # 9) Join command
    # ------------------------------------------------------------
    - name: Generate kubeadm join command
      command: kubeadm token create --print-join-command
      register: join_cmd
      changed_when: false

    - name: Save join command on master
      copy:
        dest: "{{ join_cmd_remote_path }}"
        content: |
          #!/bin/bash
          {{ join_cmd.stdout }}
        mode: "0755"

    - name: Fetch join command to controller
      fetch:
        src: "{{ join_cmd_remote_path }}"
        dest: "{{ join_cmd_local_path }}"
        flat: true

  handlers:
    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
